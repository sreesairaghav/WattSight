<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WattSight - EV Charging Station Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme Colors */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            
            /* Light Theme Variables */
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --header-bg: var(--primary-gradient);
            --sidebar-bg: #ffffff;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Dark Theme Colors */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --card-bg: #1e293b;
            --header-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --sidebar-bg: #1e293b;
            
            /* Dark theme shadows */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary) !important;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Text Color Fixes */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary) !important;
        }

        p, div, span, small {
            color: var(--text-primary) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .text-secondary {
            color: var(--text-secondary) !important;
        }

        /* Header Styles */
        .dashboard-header {
            background: var(--header-bg);
            color: white !important;
            padding: 2rem 0;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header * {
            color: white !important;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><polygon points="0,0 1000,0 1000,60 0,100"/></svg>');
            pointer-events: none;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .dashboard-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #ffffff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-subtitle {
            font-size: 1.3rem;
            font-weight: 600;
            opacity: 0.95;
            margin-bottom: 0.25rem;
        }

        .dashboard-tagline {
            font-size: 1.1rem;
            font-weight: 400;
            opacity: 0.85;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1050;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        .theme-toggle-btn {
            background: none;
            border: none;
            color: var(--text-primary) !important;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .theme-toggle-btn:hover {
            background: var(--bg-tertiary);
        }

        /* Model Status Badge */
        .model-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            animation: slideInRight 0.5s ease-out;
        }

        .status-badge {
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 20px 20px 0 0 !important;
        }

        .card-header h5 {
            color: var(--text-primary) !important;
        }

        .card-body {
            padding: 2rem;
            background: var(--card-bg);
        }

        .card-body * {
            color: var(--text-primary) !important;
        }

        /* Metric Cards */
        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            height: 100%;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            transition: opacity 0.3s ease;
        }

        .metric-card:hover::before {
            opacity: 0.15;
        }

        .metric-card.primary::before {
            background: var(--primary-gradient);
        }

        .metric-card.success::before {
            background: var(--success-gradient);
        }

        .metric-card.warning::before {
            background: var(--warning-gradient);
        }

        .metric-card.info::before {
            background: var(--info-gradient);
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            color: var(--text-primary) !important;
        }

        .metric-label {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.8;
            position: relative;
            z-index: 2;
            color: var(--text-secondary) !important;
        }

        .metric-icon {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 2rem;
            opacity: 0.2;
            z-index: 1;
            color: var(--text-primary) !important;
        }

        /* Map Styles */
        #map {
            height: 450px;
            border-radius: 15px;
            box-shadow: var(--shadow-sm);
        }

        .map-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
        }

        /* Status Indicators */
        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
        }

        .status-available { background: linear-gradient(135deg, #10b981, #059669); }
        .status-occupied { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-maintenance { background: linear-gradient(135deg, #ef4444, #dc2626); }

        /* Station List */
        .station-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .station-item * {
            color: var(--text-primary) !important;
        }

        .station-item .text-muted {
            color: var(--text-muted) !important;
        }

        .station-item:hover {
            border-color: #667eea;
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
        }

        /* Alert Items */
        .alert-item {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .alert-item * {
            color: var(--text-primary) !important;
        }

        .alert-item .text-muted {
            color: var(--text-muted) !important;
        }

        .alert-item .text-secondary {
            color: var(--text-secondary) !important;
        }

        .alert-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
        }

        .alert-critical { border-left-color: #dc2626; }
        .alert-high { border-left-color: #ef4444; }
        .alert-medium { border-left-color: #f59e0b; }
        .alert-low { border-left-color: #10b981; }

        /* Recommendation Items */
        .recommendation-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .recommendation-item * {
            color: var(--text-primary) !important;
        }

        .recommendation-item .text-muted {
            color: var(--text-muted) !important;
        }

        .recommendation-item .text-info {
            color: #0dcaf0 !important;
        }

        .recommendation-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--success-gradient);
        }

        .recommendation-item:hover {
            border-color: #10b981;
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Form Controls */
        .form-select {
            border-radius: 15px;
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: var(--card-bg);
            color: var(--text-primary) !important;
        }

        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            background: var(--card-bg);
            color: var(--text-primary) !important;
        }

        /* Tables */
        .table {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            color: var(--text-primary) !important;
            background: var(--card-bg);
        }

        .table td, .table th {
            color: var(--text-primary) !important;
            background: var(--card-bg);
        }

        .table-dark {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }

        .table-dark td, .table-dark th {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .table-dark {
            background: var(--bg-tertiary) !important;
        }

        [data-theme="dark"] .table-dark td, 
        [data-theme="dark"] .table-dark th {
            background: var(--bg-tertiary) !important;
        }

        .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: var(--bg-tertiary) !important;
        }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary) !important;
        }

        .loading p {
            color: var(--text-secondary) !important;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #667eea;
        }

        /* Badges */
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .badge-gradient {
            background: var(--primary-gradient);
            color: white !important;
        }

        /* Footer */
        footer {
            background: var(--bg-secondary);
            color: var(--text-primary) !important;
            padding: 2rem 0;
            margin-top: 4rem;
            border-top: 1px solid var(--border-color);
        }

        footer p {
            color: var(--text-primary) !important;
        }

        /* Status Pills */
        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pill-success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46 !important;
        }

        .status-pill-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e !important;
        }

        .status-pill-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b !important;
        }

        [data-theme="dark"] .status-pill-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399 !important;
        }

        [data-theme="dark"] .status-pill-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24 !important;
        }

        [data-theme="dark"] .status-pill-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171 !important;
        }

        /* Buttons */
        .btn {
            border-radius: 50px;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: var(--shadow-sm);
            color: white !important;
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            color: white !important;
        }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: var(--shadow-sm);
            color: white !important;
        }

        .btn-success:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            color: white !important;
        }

        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea !important;
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white !important;
        }

        .btn-outline-success {
            border: 2px solid #10b981;
            color: #10b981 !important;
            background: transparent;
        }

        .btn-outline-success:hover {
            background: var(--success-gradient);
            border-color: transparent;
            color: white !important;
        }

        /* WattSight Branding */
        .wattsight-logo {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .brand-icon {
            background: linear-gradient(45deg, #10b981, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Animations */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-in-up {
            animation: slideInUp 0.5s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 2.5rem;
            }
            
            .metric-value {
                font-size: 2.5rem;
            }
            
            .theme-toggle {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 1rem;
            }
            
            .model-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
    </style>
</head>
<body data-theme="light">
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" onclick="toggleTheme()" id="theme-toggle-btn" title="Toggle Dark Mode">
            <i class="fas fa-sun"></i>
        </button>
    </div>

    <!-- Model Status Badge -->
    <div class="model-status">
        <span class="badge status-badge bg-info" id="model-status-badge">
            <i class="fas fa-cog fa-spin me-2"></i>
            Initializing...
        </span>
    </div>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center header-content">
                <div class="col-lg-8">
                    <h1 class="dashboard-title wattsight-logo">
                        <i class="fas fa-bolt brand-icon me-3"></i>
                        WattSight
                    </h1>
                    <p class="dashboard-subtitle mb-2">
                        EV Charging Station Management
                    </p>
                    <p class="dashboard-tagline mb-0">
                        Real-time monitoring, predictive analytics, and intelligent insights
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <div class="d-inline-flex align-items-center bg-white bg-opacity-10 rounded-pill px-3 py-2">
                        <i class="fas fa-clock me-2"></i>
                        <small id="last-updated">Initializing...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="metric-card primary slide-in-up">
                    <i class="fas fa-charging-station metric-icon"></i>
                    <div class="metric-value" id="total-stations">
                        <div class="spinner-border"></div>
                    </div>
                    <div class="metric-label">Total Stations</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="metric-card success slide-in-up" style="animation-delay: 0.1s">
                    <i class="fas fa-check-circle metric-icon"></i>
                    <div class="metric-value" id="available-stations">
                        <div class="spinner-border"></div>
                    </div>
                    <div class="metric-label">Available Now</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="metric-card warning slide-in-up" style="animation-delay: 0.2s">
                    <i class="fas fa-plug metric-icon"></i>
                    <div class="metric-value" id="active-sessions">
                        <div class="spinner-border"></div>
                    </div>
                    <div class="metric-label">Active Sessions</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="metric-card info slide-in-up" style="animation-delay: 0.3s">
                    <i class="fas fa-battery-three-quarters metric-icon"></i>
                    <div class="metric-value" id="total-energy">
                        <div class="spinner-border"></div>
                    </div>
                    <div class="metric-label">Total Energy (kWh)</div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Row -->
        <div class="row">
            <!-- Station Map -->
            <div class="col-xl-8 mb-4">
                <div class="card fade-in">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                            Station Locations & Real-time Status
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshMap()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="map-container">
                            <div id="map"></div>
                            <div id="map-loading" class="loading">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-3 mb-0">Loading interactive map...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Station Status List -->
            <div class="col-xl-4 mb-4">
                <div class="card fade-in" style="animation-delay: 0.2s">
                    <div class="card-header">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-list me-2 text-success"></i>
                            Live Station Status
                        </h5>
                    </div>
                    <div class="card-body p-3" style="max-height: 520px; overflow-y: auto;">
                        <div id="station-status-list">
                            <div class="loading">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-3">Loading station data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Row -->
        <div class="row">
            <!-- Demand Forecast -->
            <div class="col-xl-6 mb-4">
                <div class="card fade-in" style="animation-delay: 0.4s">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-chart-line me-2 text-info"></i>
                            24-Hour Demand Forecast
                        </h5>
                        <select id="station-select" class="form-select form-select-sm" style="width: auto;">
                            <option value="Station_1">Station 1</option>
                            <option value="Station_2">Station 2</option>
                            <option value="Station_3">Station 3</option>
                            <option value="Station_5">Station 5</option>
                            <option value="Station_10">Station 10</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="demand-chart"></canvas>
                            <div id="demand-loading" class="loading">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-3">Generating forecast...</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mt-3">
                            <div class="status-pill status-pill-success me-3">
                                <i class="fas fa-robot me-1"></i>
                                <small id="demand-model-status">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Energy Consumption -->
            <div class="col-xl-6 mb-4">
                <div class="card fade-in" style="animation-delay: 0.5s">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-chart-bar me-2 text-warning"></i>
                            7-Day Energy Forecast
                        </h5>
                        <select id="city-select" class="form-select form-select-sm" style="width: auto;">
                            <option value="Los Angeles">Los Angeles</option>
                            <option value="San Francisco">San Francisco</option>
                            <option value="Houston">Houston</option>
                            <option value="Chicago">Chicago</option>
                            <option value="New York">New York</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="energy-chart"></canvas>
                            <div id="energy-loading" class="loading">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-3">Analyzing energy patterns...</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mt-3">
                            <div class="status-pill status-pill-success me-3">
                                <i class="fas fa-brain me-1"></i>
                                <small id="energy-model-status">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts and Recommendations Row -->
        <div class="row">
            <!-- Anomaly Alerts -->
            <div class="col-xl-6 mb-4">
                <div class="card fade-in" style="animation-delay: 0.6s">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                            Anomaly Detection
                        </h5>
                        <span class="badge badge-gradient" id="alert-count">0</span>
                    </div>
                    <div class="card-body p-3" style="max-height: 400px; overflow-y: auto;">
                        <div id="alerts-list">
                            <div class="loading">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-3">Scanning for anomalies...</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="status-pill status-pill-warning">
                                <i class="fas fa-shield-alt me-1"></i>
                                <small id="anomaly-model-status">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placement Recommendations -->
            <div class="col-xl-6 mb-4">
                <div class="card fade-in" style="animation-delay: 0.7s">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-map-pin me-2 text-success"></i>
                            Optimal Placement AI
                        </h5>
                        <button class="btn btn-outline-success btn-sm" onclick="showRecommendationsOnMap()">
                            <i class="fas fa-map me-2"></i>View on Map
                        </button>
                    </div>
                    <div class="card-body p-3" style="max-height: 400px; overflow-y: auto;">
                        <div id="recommendations-list">
                            <div class="loading">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-3">Analyzing optimal locations...</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="status-pill status-pill-success">
                                <i class="fas fa-lightbulb me-1"></i>
                                <small id="placement-model-status">Loading...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- City Statistics Row -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card fade-in" style="animation-delay: 0.8s">
                    <div class="card-header">
                        <h5 class="mb-0 fw-600">
                            <i class="fas fa-city me-2 text-primary"></i>
                            Regional Performance Analytics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="fw-600"><i class="fas fa-map-marker me-2"></i>City</th>
                                        <th class="fw-600"><i class="fas fa-charging-station me-2"></i>Stations</th>
                                        <th class="fw-600"><i class="fas fa-chart-line me-2"></i>Avg Energy (kWh)</th>
                                        <th class="fw-600"><i class="fas fa-battery-full me-2"></i>Total Energy (kWh)</th>
                                        <th class="fw-600"><i class="fas fa-tachometer-alt me-2"></i>Avg Rate (kW)</th>
                                    </tr>
                                </thead>
                                <tbody id="city-stats-table">
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <div class="spinner-border text-primary"></div>
                                            <p class="mt-3 mb-0">Loading regional analytics...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <p class="mb-0">
                        <i class="fas fa-leaf me-2"></i>
                        &copy; 2025 WattSight | EV Charging Management System 
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let map;
        let demandChart, energyChart;
        let stationMarkers = [];
        let recommendationMarkers = [];
        let modelStatus = {};
        let isInitialized = false;
        let currentTheme = 'light';

        // Theme Toggle Function
        function toggleTheme() {
            const body = document.body;
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            
            if (currentTheme === 'light') {
                body.setAttribute('data-theme', 'dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                currentTheme = 'dark';
                localStorage.setItem('wattsight-theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
                currentTheme = 'light';
                localStorage.setItem('wattsight-theme', 'light');
            }
            
            // Update charts with new theme
            if (demandChart) {
                updateChartTheme(demandChart);
            }
            if (energyChart) {
                updateChartTheme(energyChart);
            }
            
            // Update map tiles for dark theme
            updateMapTheme();
        }

        // Initialize theme from localStorage
        function initializeTheme() {
            const savedTheme = localStorage.getItem('wattsight-theme') || 'light';
            const body = document.body;
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                currentTheme = 'dark';
            } else {
                body.setAttribute('data-theme', 'light');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
                currentTheme = 'light';
            }
        }

        // Update chart theme
        function updateChartTheme(chart) {
            const isDark = currentTheme === 'dark';
            chart.options.scales.x.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
            chart.options.scales.y.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
            chart.options.scales.x.ticks.color = isDark ? '#cbd5e1' : '#718096';
            chart.options.scales.y.ticks.color = isDark ? '#cbd5e1' : '#718096';
            chart.options.scales.x.title.color = isDark ? '#f1f5f9' : '#2d3748';
            chart.options.scales.y.title.color = isDark ? '#f1f5f9' : '#2d3748';
            chart.update();
        }

        // Update map theme
        function updateMapTheme() {
            if (map) {
                // Remove existing tile layer
                map.eachLayer(function(layer) {
                    if (layer instanceof L.TileLayer) {
                        map.removeLayer(layer);
                    }
                });
                
                // Add appropriate tile layer
                const isDark = currentTheme === 'dark';
                const tileUrl = isDark 
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                    : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
                
                L.tileLayer(tileUrl, {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing WattSight dashboard...');
            initializeTheme();
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                console.log('📡 Loading model status...');
                await loadModelStatus();
                
                console.log('🗺️ Initializing interactive map...');
                initializeMap();
                
                console.log('📊 Loading dashboard data...');
                await Promise.all([
                    loadStationStatus(),
                    loadDemandForecast(),
                    loadEnergyForecast(),
                    loadAnomalyAlerts(),
                    loadPlacementRecommendations(),
                    loadCityStats()
                ]);
                
                updateLastUpdated();
                isInitialized = true;
                console.log('✅ WattSight dashboard initialized successfully!');
                
                // Set up auto-refresh with visual feedback
                setInterval(() => {
                    loadStationStatus();
                    updateLastUpdated();
                }, 30000);
                
                setInterval(loadAnomalyAlerts, 60000);
                
            } catch (error) {
                console.error('❌ Error initializing dashboard:', error);
                showError('Failed to initialize dashboard. Please refresh the page.');
            }
        }

        function initializeMap() {
            try {
                document.getElementById('map-loading').style.display = 'flex';
                
                // Initialize map with theme-appropriate styling
                map = L.map('map').setView([39.8283, -98.5795], 4);
                
                // Apply initial theme
                updateMapTheme();
                
                map.whenReady(() => {
                    document.getElementById('map-loading').style.display = 'none';
                });
                
                console.log('✅ Professional map initialized with theme support');
            } catch (error) {
                console.error('❌ Error initializing map:', error);
                document.getElementById('map-loading').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading map</div>';
            }
        }

        // Event listeners
        document.getElementById('station-select').addEventListener('change', loadDemandForecast);
        document.getElementById('city-select').addEventListener('change', loadEnergyForecast);

        async function loadModelStatus() {
            try {
                const response = await fetch('/api/model_status');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                modelStatus = await response.json();
                
                const loadedModels = modelStatus.loaded_models || [];
                const statusBadge = document.getElementById('model-status-badge');
                
                if (loadedModels.length === 4) {
                    statusBadge.innerHTML = '<i class="fas fa-check-circle me-2"></i>All AI Models Active';
                    statusBadge.className = 'badge status-badge bg-success';
                } else if (loadedModels.length > 0) {
                    statusBadge.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${loadedModels.length}/4 Models Active`;
                    statusBadge.className = 'badge status-badge bg-warning';
                } else {
                    statusBadge.innerHTML = '<i class="fas fa-play-circle me-2"></i>Demo Mode';
                    statusBadge.className = 'badge status-badge bg-secondary';
                }
                
                console.log('✅ Model Status loaded:', modelStatus);
            } catch (error) {
                console.error('❌ Error loading model status:', error);
                const statusBadge = document.getElementById('model-status-badge');
                statusBadge.innerHTML = '<i class="fas fa-times-circle me-2"></i>Connection Error';
                statusBadge.className = 'badge status-badge bg-danger';
            }
        }

        async function loadStationStatus() {
            try {
                const response = await fetch('/api/station_status');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const stations = await response.json();
                
                // Update station select dropdown
                const stationSelect = document.getElementById('station-select');
                stationSelect.innerHTML = '';
                stations.slice(0, 5).forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = `${station.id} - ${station.city}`;
                    stationSelect.appendChild(option);
                });
                
                // Update metrics with animations
                animateCounter('total-stations', stations.length);
                animateCounter('available-stations', stations.filter(s => s.status === 'Available').length);
                animateCounter('active-sessions', stations.filter(s => s.status === 'Occupied').length);
                
                // Clear existing markers
                stationMarkers.forEach(marker => map.removeLayer(marker));
                stationMarkers = [];
                
                // Add enhanced station markers
                stations.forEach(station => {
                    const color = station.status === 'Available' ? '#10b981' : 
                                 station.status === 'Occupied' ? '#f59e0b' : '#ef4444';
                    
                    const marker = L.circleMarker([station.latitude, station.longitude], {
                        color: '#ffffff',
                        fillColor: color,
                        fillOpacity: 0.8,
                        radius: 10,
                        weight: 2
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div class="text-center p-2" style="min-width: 200px;">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-charging-station me-2 text-primary"></i>
                                ${station.id}
                            </h6>
                            <hr class="my-2">
                            <div class="text-start">
                                <p class="mb-2">
                                    <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                                    <strong>Location:</strong> ${station.city}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-info-circle me-2 text-muted"></i>
                                    <strong>Status:</strong> 
                                    <span class="badge bg-${getStatusColor(station.status)}">${station.status}</span>
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-chart-pie me-2 text-muted"></i>
                                    <strong>Utilization:</strong> ${station.utilization}%
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-plug me-2 text-muted"></i>
                                    <strong>Type:</strong> ${station.charger_type}
                                </p>
                            </div>
                        </div>
                    `);
                    
                    stationMarkers.push(marker);
                });
                
                // Update station status list
                const statusList = document.getElementById('station-status-list');
                statusList.innerHTML = stations.slice(0, 10).map(station => `
                    <div class="station-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-${station.status.toLowerCase()}"></span>
                                <div>
                                    <h6 class="mb-1 fw-bold text-primary">${station.id}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        ${station.city} • ${station.charger_type}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold fs-5 mb-1">${station.utilization}%</div>
                                <span class="badge bg-${getStatusColor(station.status)} rounded-pill">
                                    ${station.status}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                console.log('✅ Station status loaded with enhanced styling');
                
            } catch (error) {
                console.error('❌ Error loading station status:', error);
                document.getElementById('station-status-list').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading station data</div>';
            }
        }

        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
                
                element.textContent = currentValue.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            
            requestAnimationFrame(updateCounter);
        }

        async function loadDemandForecast() {
            try {
                document.getElementById('demand-loading').style.display = 'flex';
                
                const stationId = document.getElementById('station-select').value;
                const response = await fetch(`/api/demand_forecast?station_id=${stationId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                const ctx = document.getElementById('demand-chart').getContext('2d');
                
                if (demandChart) {
                    demandChart.destroy();
                }
                
                const isDark = currentTheme === 'dark';
                
                demandChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.forecast.map(f => f.hour),
                        datasets: [{
                            label: 'Predicted Demand',
                            data: data.forecast.map(f => f.demand),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Sessions',
                                    font: { weight: 'bold' },
                                    color: isDark ? '#f1f5f9' : '#2d3748'
                                },
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    color: isDark ? '#cbd5e1' : '#718096'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour of Day',
                                    font: { weight: 'bold' },
                                    color: isDark ? '#f1f5f9' : '#2d3748'
                                },
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    color: isDark ? '#cbd5e1' : '#718096'
                                }
                            }
                        }
                    }
                });
                
                const statusText = data.model_used ? 
                    `AI Model Active (${data.model_type || 'ML'})` : 
                    'Intelligent Simulation';
                document.getElementById('demand-model-status').textContent = statusText;
                
                document.getElementById('demand-loading').style.display = 'none';
                console.log('✅ Enhanced demand forecast loaded');
                
            } catch (error) {
                console.error('❌ Error loading demand forecast:', error);
                document.getElementById('demand-model-status').textContent = 'Error loading forecast';
                document.getElementById('demand-loading').style.display = 'none';
            }
        }

        async function loadEnergyForecast() {
            try {
                document.getElementById('energy-loading').style.display = 'flex';
                
                const city = document.getElementById('city-select').value;
                const response = await fetch(`/api/energy_forecast?city=${city}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                const ctx = document.getElementById('energy-chart').getContext('2d');
                
                if (energyChart) {
                    energyChart.destroy();
                }
                
                const isDark = currentTheme === 'dark';
                
                energyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.forecast.map(f => new Date(f.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Energy Consumption (kWh)',
                            data: data.forecast.map(f => f.total_energy_kwh),
                            backgroundColor: 'rgba(245, 158, 11, 0.8)',
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Energy Consumption (kWh)',
                                    font: { weight: 'bold' },
                                    color: isDark ? '#f1f5f9' : '#2d3748'
                                },
                                grid: {
                                    color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    color: isDark ? '#cbd5e1' : '#718096'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: isDark ? '#cbd5e1' : '#718096'
                                }
                            }
                        }
                    }
                });
                
                // Animate total energy counter
                const totalEnergy = data.forecast.reduce((sum, f) => sum + f.total_energy_kwh, 0);
                animateCounter('total-energy', Math.round(totalEnergy));
                
                const statusText = data.model_used ? 
                    'AI Energy Model Active' : 
                    'Intelligent Pattern Analysis';
                document.getElementById('energy-model-status').textContent = statusText;
                
                document.getElementById('energy-loading').style.display = 'none';
                console.log('✅ Enhanced energy forecast loaded');
                
            } catch (error) {
                console.error('❌ Error loading energy forecast:', error);
                document.getElementById('energy-model-status').textContent = 'Error loading forecast';
                document.getElementById('energy-loading').style.display = 'none';
            }
        }

        async function loadAnomalyAlerts() {
            try {
                const response = await fetch('/api/anomaly_alerts');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const alerts = await response.json();
                
                document.getElementById('alert-count').textContent = 
                    alerts.filter(a => a.status === 'New').length;
                
                const alertsList = document.getElementById('alerts-list');
                alertsList.innerHTML = alerts.slice(0, 6).map(alert => `
                    <div class="alert-item alert-${alert.severity.toLowerCase()}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ${alert.alert_type}
                                    <span class="badge bg-${getSeverityColor(alert.severity)} ms-2">${alert.severity}</span>
                                </h6>
                                <p class="mb-2 text-muted">
                                    <i class="fas fa-charging-station me-2"></i>
                                    ${alert.station_id}
                                </p>
                                <small class="text-secondary">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ${alert.description}
                                </small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block mb-1">
                                    <i class="fas fa-clock me-1"></i>
                                    ${new Date(alert.timestamp).toLocaleTimeString()}
                                </small>
                                <span class="badge bg-secondary rounded-pill">${alert.status}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                const modelUsed = alerts.length > 0 ? alerts[0].model_used : false;
                const statusText = modelUsed ? 
                    'AI Anomaly Detection Active' : 
                    'Pattern Recognition Active';
                document.getElementById('anomaly-model-status').textContent = statusText;
                
                console.log('✅ Enhanced anomaly alerts loaded');
                
            } catch (error) {
                console.error('❌ Error loading anomaly alerts:', error);
                document.getElementById('alerts-list').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading alerts</div>';
            }
        }

        async function loadPlacementRecommendations() {
            try {
                const response = await fetch('/api/placement_recommendations');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const recommendations = data.recommendations || [];
                
                const recommendationsList = document.getElementById('recommendations-list');
                recommendationsList.innerHTML = recommendations.map((rec, index) => `
                    <div class="recommendation-item" data-lat="${rec.latitude}" data-lng="${rec.longitude}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-2">
                                    <i class="fas fa-map-pin me-2 text-success"></i>
                                    ${rec.metro_area || `Location ${rec.id}`}
                                    <span class="badge badge-gradient ms-2">${(rec.priority_score * 100).toFixed(0)}%</span>
                                </h6>
                                <div class="small text-muted">
                                    <p class="mb-1">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        ${rec.latitude}, ${rec.longitude}
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Est. Demand: <strong>${rec.estimated_demand}</strong> sessions/day
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-expand-arrows-alt me-2"></i>
                                        Coverage: <strong>${rec.coverage_radius}</strong> km radius
                                    </p>
                                    <p class="mb-0 text-info">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        ${rec.reasoning || 'Strategic location for EV charging'}
                                    </p>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="focusOnLocation(${rec.latitude}, ${rec.longitude})">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                const statusText = data.model_used ? 
                    'AI Placement Optimization' : 
                    'Geographic Intelligence';
                document.getElementById('placement-model-status').textContent = statusText;
                
                console.log('✅ Enhanced placement recommendations loaded');
                
            } catch (error) {
                console.error('❌ Error loading placement recommendations:', error);
                document.getElementById('recommendations-list').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading recommendations</div>';
            }
        }

        async function loadCityStats() {
            try {
                const response = await fetch('/api/city_stats');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const stats = await response.json();
                
                const tableBody = document.getElementById('city-stats-table');
                tableBody.innerHTML = stats.map(stat => `
                    <tr class="fade-in">
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-city me-2 text-primary"></i>
                                <strong>${stat.city}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-gradient fs-6">${stat.total_stations}</span>
                        </td>
                        <td class="fw-600">${stat.avg_energy_consumption.toFixed(1)}</td>
                        <td class="fw-bold text-success">${stat.total_energy_consumption.toLocaleString()}</td>
                        <td class="fw-600">${stat.avg_charging_rate.toFixed(1)}</td>
                    </tr>
                `).join('');
                
                console.log('✅ Enhanced city statistics loaded');
                
            } catch (error) {
                console.error('❌ Error loading city stats:', error);
                document.getElementById('city-stats-table').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle me-2"></i>Error loading statistics</td></tr>';
            }
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'Available': 'success',
                'Occupied': 'warning',
                'Maintenance': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getSeverityColor(severity) {
            const colors = {
                'Low': 'success',
                'Medium': 'warning',
                'High': 'danger',
                'Critical': 'dark'
            };
            return colors[severity] || 'secondary';
        }

        function refreshMap() {
            console.log('🔄 Refreshing map data...');
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
            
            loadStationStatus().then(() => {
                btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh';
            });
        }

        function focusOnLocation(lat, lng) {
            if (map) {
                map.setView([lat, lng], 12);
                const highlightMarker = L.circleMarker([lat, lng], {
                    color: '#10b981',
                    fillColor: '#10b981',
                    fillOpacity: 0.5,
                    radius: 20,
                    weight: 3
                }).addTo(map);
                
                setTimeout(() => {
                    map.removeLayer(highlightMarker);
                }, 3000);
                
                console.log(`📍 Focused on location: ${lat}, ${lng}`);
            }
        }

        function showRecommendationsOnMap() {
            console.log('🗺️ Displaying AI recommendations on map...');
            
            recommendationMarkers.forEach(marker => map.removeLayer(marker));
            recommendationMarkers = [];
            
            document.querySelectorAll('.recommendation-item').forEach((item, index) => {
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'recommendation-marker',
                            html: `<div style="
                                background: linear-gradient(135deg, #10b981, #059669); 
                                color: white; 
                                border-radius: 50%; 
                                width: 40px; 
                                height: 40px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-weight: bold;
                                border: 3px solid white;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                                font-size: 16px;
                            ">R${index + 1}</div>`,
                            iconSize: [40, 40]
                        })
                    }).addTo(map);
                    
                    const recTitle = item.querySelector('h6 strong').textContent.replace(/🌟|📍/g, '').trim();
                    const priorityText = item.querySelector('.badge').textContent;
                    const reasoningElement = item.querySelector('.text-info');
                    const reasoning = reasoningElement ? reasoningElement.textContent.replace('💡', '').trim() : 'Strategic location';
                    
                    marker.bindPopup(`
                        <div class="text-center p-3" style="min-width: 280px;">
                            <h6 class="fw-bold mb-3">
                                <i class="fas fa-star text-warning me-2"></i>
                                ${recTitle}
                            </h6>
                            <hr class="my-2">
                            <div class="text-start">
                                <p class="mb-2">
                                    <i class="fas fa-chart-line me-2 text-success"></i>
                                    <strong>Priority Score:</strong> ${priorityText}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-users me-2 text-info"></i>
                                    <strong>Expected Daily Sessions:</strong> ${Math.floor(Math.random() * 200 + 80)}
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-expand-arrows-alt me-2 text-warning"></i>
                                    <strong>Coverage Radius:</strong> ${(Math.random() * 10 + 3).toFixed(1)} km
                                </p>
                                <p class="mb-0 small">
                                    <i class="fas fa-lightbulb me-2 text-primary"></i>
                                    <strong>AI Insight:</strong> ${reasoning}
                                </p>
                            </div>
                        </div>
                    `);
                    
                    recommendationMarkers.push(marker);
                }
            });
            
            if (recommendationMarkers.length > 0) {
                const group = new L.featureGroup(recommendationMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
                
                if (map.getZoom() < 4) {
                    map.setZoom(4);
                }
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').innerHTML = 
                `<i class="fas fa-clock me-1"></i>Updated: ${now.toLocaleTimeString()}`;
        }

        function showError(message) {
            console.error('❌ Dashboard Error:', message);
        }

        window.addEventListener('error', function(e) {
            console.error('🚨 JavaScript Error:', e.error);
        });

        console.log('🎨 WattSight professional dashboard initialized with fixed dark theme text colors');
    </script>
</body>
</html>
