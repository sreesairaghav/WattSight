<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charging Station Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .dashboard-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card { 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
        }
        .status-available { background-color: #28a745; }
        .status-occupied { background-color: #ffc107; }
        .status-maintenance { background-color: #dc3545; }
        .status-indicator { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 8px; 
        }
        #map { 
            height: 400px; 
            border-radius: 8px;
        }
        .metric-card { 
            text-align: center; 
            padding: 30px 20px;
            border-radius: 15px;
        }
        .metric-value { 
            font-size: 2.5rem; 
            font-weight: bold; 
            margin-bottom: 10px;
        }
        .metric-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        .alert-item { 
            border-left: 4px solid; 
            padding: 15px; 
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            background: #f8f9fa;
        }
        .alert-high { border-left-color: #dc3545; }
        .alert-medium { border-left-color: #ffc107; }
        .alert-low { border-left-color: #28a745; }
        .alert-critical { border-left-color: #6f42c1; }
        .model-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .card-header {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
            border-radius: 10px 10px 0 0 !important;
        }
    </style>
</head>
<body>
    <!-- Model Status Indicator -->
    <div class="model-status">
        <span class="badge bg-info fs-6" id="model-status-badge">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Loading...
        </span>
    </div>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">üîã EV Charging Station Management Dashboard</h1>
                    <p class="mb-0 fs-5">Real-time monitoring and predictive analytics</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-white-50">
                        <small id="last-updated">Last updated: Loading...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-primary text-white h-100">
                    <div class="metric-value" id="total-stations">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div class="metric-label">Total Stations</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-success text-white h-100">
                    <div class="metric-value" id="available-stations">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div class="metric-label">Available Now</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-warning text-white h-100">
                    <div class="metric-value" id="active-sessions">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div class="metric-label">Active Sessions</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card bg-info text-white h-100">
                    <div class="metric-value" id="total-energy">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div class="metric-label">Total Energy (kWh)</div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Row -->
        <div class="row">
            <!-- Station Map -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìç Station Locations & Status</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshMap()">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="map-container">
                            <div id="map"></div>
                            <div id="map-loading" class="loading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-3">Loading station map...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Station Status List -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Station Status</h5>
                    </div>
                    <div class="card-body" style="max-height: 450px; overflow-y: auto;">
                        <div id="station-status-list">
                            <div class="loading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-3">Loading station data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <!-- Demand Forecast -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìà 24-Hour Demand Forecast</h5>
                        <select id="station-select" class="form-select form-select-sm" style="width: auto;">
                            <option value="Station_1">Station 1</option>
                            <option value="Station_2">Station 2</option>
                            <option value="Station_3">Station 3</option>
                            <option value="Station_5">Station 5</option>
                            <option value="Station_10">Station 10</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="demand-chart-container">
                            <canvas id="demand-chart" width="400" height="200"></canvas>
                            <div id="demand-loading" class="loading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-3">Loading demand forecast...</p>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" id="demand-model-status">Loading...</small>
                    </div>
                </div>
            </div>

            <!-- Energy Consumption -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">‚ö° 7-Day Energy Forecast</h5>
                        <select id="city-select" class="form-select form-select-sm" style="width: auto;">
                            <option value="Los Angeles">Los Angeles</option>
                            <option value="San Francisco">San Francisco</option>
                            <option value="Houston">Houston</option>
                            <option value="Chicago">Chicago</option>
                            <option value="New York">New York</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="energy-chart-container">
                            <canvas id="energy-chart" width="400" height="200"></canvas>
                            <div id="energy-loading" class="loading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-3">Loading energy forecast...</p>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" id="energy-model-status">Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts and Recommendations Row -->
        <div class="row">
            <!-- Anomaly Alerts -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üö® Recent Anomaly Alerts</h5>
                        <span class="badge bg-danger fs-6" id="alert-count">0</span>
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <div id="alerts-list">
                            <div class="loading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-3">Loading alerts...</p>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" id="anomaly-model-status">Loading...</small>
                    </div>
                </div>
            </div>

            <!-- Placement Recommendations -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìç Optimal Placement Recommendations</h5>
                        <button class="btn btn-sm btn-outline-success" onclick="showRecommendationsOnMap()">
                            üó∫Ô∏è Show on Map
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <div id="recommendations-list">
                            <div class="loading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-3">Loading recommendations...</p>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" id="placement-model-status">Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- City Statistics Row -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üèôÔ∏è City Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>City</th>
                                        <th>Total Stations</th>
                                        <th>Avg Energy (kWh)</th>
                                        <th>Total Energy (kWh)</th>
                                        <th>Avg Charging Rate (kW)</th>
                                    </tr>
                                </thead>
                                <tbody id="city-stats-table">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-3 mb-0">Loading city statistics...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2025 EV Charging Management System | Real-time Analytics Dashboard</p>
        </div>
    </footer>

    <script>
        // Global variables
        let map;
        let demandChart, energyChart;
        let stationMarkers = [];
        let recommendationMarkers = [];
        let modelStatus = {};
        let isInitialized = false;

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing dashboard...');
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                console.log('üì° Loading model status...');
                await loadModelStatus();
                
                console.log('üó∫Ô∏è Initializing map...');
                initializeMap();
                
                console.log('üìä Loading initial data...');
                await Promise.all([
                    loadStationStatus(),
                    loadDemandForecast(),
                    loadEnergyForecast(),
                    loadAnomalyAlerts(),
                    loadPlacementRecommendations(),
                    loadCityStats()
                ]);
                
                updateLastUpdated();
                isInitialized = true;
                console.log('‚úÖ Dashboard initialized successfully!');
                
                // Set up auto-refresh
                setInterval(loadStationStatus, 30000);
                setInterval(loadAnomalyAlerts, 60000);
                setInterval(updateLastUpdated, 60000);
                
            } catch (error) {
                console.error('‚ùå Error initializing dashboard:', error);
                showError('Failed to initialize dashboard. Please refresh the page.');
            }
        }

        function initializeMap() {
            try {
                // Show loading initially
                document.getElementById('map-loading').style.display = 'block';
                
                // Initialize map
                map = L.map('map').setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Hide loading when map is ready
                map.whenReady(() => {
                    document.getElementById('map-loading').style.display = 'none';
                });
                
                console.log('‚úÖ Map initialized');
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                document.getElementById('map-loading').innerHTML = 
                    '<div class="alert alert-danger">Error loading map</div>';
            }
        }

        // Event listeners
        document.getElementById('station-select').addEventListener('change', loadDemandForecast);
        document.getElementById('city-select').addEventListener('change', loadEnergyForecast);

        async function loadModelStatus() {
            try {
                const response = await fetch('/api/model_status');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                modelStatus = await response.json();
                
                const loadedModels = modelStatus.loaded_models || [];
                const statusBadge = document.getElementById('model-status-badge');
                
                if (loadedModels.length === 4) {
                    statusBadge.innerHTML = '‚úÖ All Models Active';
                    statusBadge.className = 'badge bg-success fs-6';
                } else if (loadedModels.length > 0) {
                    statusBadge.innerHTML = `‚ö†Ô∏è ${loadedModels.length}/4 Models Active`;
                    statusBadge.className = 'badge bg-warning fs-6';
                } else {
                    statusBadge.innerHTML = 'üîÑ Demo Mode';
                    statusBadge.className = 'badge bg-secondary fs-6';
                }
                
                console.log('‚úÖ Model Status loaded:', modelStatus);
            } catch (error) {
                console.error('‚ùå Error loading model status:', error);
                const statusBadge = document.getElementById('model-status-badge');
                statusBadge.innerHTML = '‚ùå Connection Error';
                statusBadge.className = 'badge bg-danger fs-6';
            }
        }

        async function loadStationStatus() {
            try {
                const response = await fetch('/api/station_status');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const stations = await response.json();
                
                // Update station select dropdown with actual station IDs
                const stationSelect = document.getElementById('station-select');
                stationSelect.innerHTML = '';
                stations.slice(0, 5).forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = `${station.id} (${station.city})`;
                    stationSelect.appendChild(option);
                });
                
                // Update metrics
                document.getElementById('total-stations').textContent = stations.length;
                document.getElementById('available-stations').textContent = 
                    stations.filter(s => s.status === 'Available').length;
                document.getElementById('active-sessions').textContent = 
                    stations.filter(s => s.status === 'Occupied').length;
                
                // Clear existing markers
                stationMarkers.forEach(marker => map.removeLayer(marker));
                stationMarkers = [];
                
                // Add station markers
                stations.forEach(station => {
                    const color = station.status === 'Available' ? 'green' : 
                                 station.status === 'Occupied' ? 'orange' : 'red';
                    
                    const marker = L.circleMarker([station.latitude, station.longitude], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.7,
                        radius: 8
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div class="text-center">
                            <h6><strong>${station.id}</strong></h6>
                            <hr class="my-2">
                            <p class="mb-1"><strong>City:</strong> ${station.city}</p>
                            <p class="mb-1"><strong>Status:</strong> 
                                <span class="badge bg-${getStatusColor(station.status)}">${station.status}</span>
                            </p>
                            <p class="mb-1"><strong>Utilization:</strong> ${station.utilization}%</p>
                            <p class="mb-0"><strong>Type:</strong> ${station.charger_type}</p>
                        </div>
                    `);
                    
                    stationMarkers.push(marker);
                });
                
                // Update station status list
                const statusList = document.getElementById('station-status-list');
                statusList.innerHTML = stations.slice(0, 10).map(station => `
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded shadow-sm">
                        <div>
                            <span class="status-indicator status-${station.status.toLowerCase()}"></span>
                            <strong class="text-primary">${station.id}</strong>
                            <br><small class="text-muted">${station.city} ‚Ä¢ ${station.charger_type}</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-${getStatusColor(station.status)} fs-6 mb-1">${station.utilization}%</div>
                            <br><small class="text-muted">${station.status}</small>
                        </div>
                    </div>
                `).join('');
                
                console.log('‚úÖ Station status loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading station status:', error);
                document.getElementById('station-status-list').innerHTML = 
                    '<div class="alert alert-danger">‚ùå Error loading station data</div>';
            }
        }

        async function loadDemandForecast() {
            try {
                document.getElementById('demand-loading').style.display = 'block';
                
                const stationId = document.getElementById('station-select').value;
                const response = await fetch(`/api/demand_forecast?station_id=${stationId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                const ctx = document.getElementById('demand-chart').getContext('2d');
                
                if (demandChart) {
                    demandChart.destroy();
                }
                
                demandChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.forecast.map(f => f.hour),
                        datasets: [{
                            label: 'Predicted Demand',
                            data: data.forecast.map(f => f.demand),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Sessions'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
                
                // Update model status
                const statusText = data.model_used ? 
                    `‚úÖ Using trained model (${data.model_type || 'ML'})` : 
                    'üîÑ Using intelligent simulation';
                document.getElementById('demand-model-status').textContent = statusText;
                
                document.getElementById('demand-loading').style.display = 'none';
                console.log('‚úÖ Demand forecast loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading demand forecast:', error);
                document.getElementById('demand-model-status').textContent = '‚ùå Error loading forecast';
                document.getElementById('demand-loading').style.display = 'none';
            }
        }

        async function loadEnergyForecast() {
            try {
                document.getElementById('energy-loading').style.display = 'block';
                
                const city = document.getElementById('city-select').value;
                const response = await fetch(`/api/energy_forecast?city=${city}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                const ctx = document.getElementById('energy-chart').getContext('2d');
                
                if (energyChart) {
                    energyChart.destroy();
                }
                
                energyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.forecast.map(f => new Date(f.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Total Energy (kWh)',
                            data: data.forecast.map(f => f.total_energy_kwh),
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Energy Consumption (kWh)'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
                
                // Update total energy metric
                const totalEnergy = data.forecast.reduce((sum, f) => sum + f.total_energy_kwh, 0);
                document.getElementById('total-energy').textContent = Math.round(totalEnergy).toLocaleString();
                
                // Update model status
                const statusText = data.model_used ? 
                    '‚úÖ Using trained energy model' : 
                    'üîÑ Using intelligent simulation';
                document.getElementById('energy-model-status').textContent = statusText;
                
                document.getElementById('energy-loading').style.display = 'none';
                console.log('‚úÖ Energy forecast loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading energy forecast:', error);
                document.getElementById('energy-model-status').textContent = '‚ùå Error loading forecast';
                document.getElementById('energy-loading').style.display = 'none';
            }
        }

        async function loadAnomalyAlerts() {
            try {
                const response = await fetch('/api/anomaly_alerts');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const alerts = await response.json();
                
                document.getElementById('alert-count').textContent = 
                    alerts.filter(a => a.status === 'New').length;
                
                const alertsList = document.getElementById('alerts-list');
                alertsList.innerHTML = alerts.slice(0, 8).map(alert => `
                    <div class="alert-item alert-${alert.severity.toLowerCase()} mb-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <strong>${alert.alert_type}</strong>
                                    <span class="badge bg-${getSeverityColor(alert.severity)} ms-2">${alert.severity}</span>
                                </h6>
                                <p class="mb-1 text-muted">${alert.station_id}</p>
                                <small class="text-secondary">${alert.description}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">${new Date(alert.timestamp).toLocaleTimeString()}</small>
                                <span class="badge bg-secondary mt-1">${alert.status}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Update model status
                const modelUsed = alerts.length > 0 ? alerts[0].model_used : false;
                const statusText = modelUsed ? 
                    '‚úÖ Using trained anomaly model' : 
                    'üîÑ Using intelligent simulation';
                document.getElementById('anomaly-model-status').textContent = statusText;
                
                console.log('‚úÖ Anomaly alerts loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading anomaly alerts:', error);
                document.getElementById('alerts-list').innerHTML = 
                    '<div class="alert alert-danger">‚ùå Error loading alerts</div>';
            }
        }

        async function loadPlacementRecommendations() {
            try {
                const response = await fetch('/api/placement_recommendations');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const recommendations = data.recommendations || [];
                
                const recommendationsList = document.getElementById('recommendations-list');
                recommendationsList.innerHTML = recommendations.map((rec, index) => `
                    <div class="mb-3 p-3 border rounded shadow-sm recommendation-item" 
                         data-lat="${rec.latitude}" data-lng="${rec.longitude}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">
                                    <strong>üìç ${rec.metro_area || `Location ${rec.id}`}</strong>
                                    <span class="badge bg-primary ms-2">${(rec.priority_score * 100).toFixed(0)}%</span>
                                </h6>
                                <div class="small text-muted">
                                    <p class="mb-1">üìç ${rec.latitude}, ${rec.longitude}</p>
                                    <p class="mb-1">üìä Est. Demand: ${rec.estimated_demand} sessions/day</p>
                                    <p class="mb-1">üìè Coverage: ${rec.coverage_radius} km radius</p>
                                    <p class="mb-0 text-info">üí° ${rec.reasoning || 'Strategic location for EV charging'}</p>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="focusOnLocation(${rec.latitude}, ${rec.longitude})">
                                üîç View
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Update model status
                const statusText = data.model_used ? 
                    '‚úÖ Using trained placement model' : 
                    'üîÑ Using intelligent geographic analysis';
                document.getElementById('placement-model-status').textContent = statusText;
                
                console.log('‚úÖ Placement recommendations loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading placement recommendations:', error);
                document.getElementById('recommendations-list').innerHTML = 
                    '<div class="alert alert-danger">‚ùå Error loading recommendations</div>';
            }
        }

        async function loadCityStats() {
            try {
                const response = await fetch('/api/city_stats');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const stats = await response.json();
                
                const tableBody = document.getElementById('city-stats-table');
                tableBody.innerHTML = stats.map(stat => `
                    <tr>
                        <td><strong>${stat.city}</strong></td>
                        <td><span class="badge bg-primary">${stat.total_stations}</span></td>
                        <td>${stat.avg_energy_consumption.toFixed(1)}</td>
                        <td><strong>${stat.total_energy_consumption.toLocaleString()}</strong></td>
                        <td>${stat.avg_charging_rate.toFixed(1)}</td>
                    </tr>
                `).join('');
                
                console.log('‚úÖ City stats loaded');
                
            } catch (error) {
                console.error('‚ùå Error loading city stats:', error);
                document.getElementById('city-stats-table').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger py-4">‚ùå Error loading statistics</td></tr>';
            }
        }

        // Helper functions
        function getStatusColor(status) {
            const colors = {
                'Available': 'success',
                'Occupied': 'warning',
                'Maintenance': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getSeverityColor(severity) {
            const colors = {
                'Low': 'success',
                'Medium': 'warning',
                'High': 'danger',
                'Critical': 'dark'
            };
            return colors[severity] || 'secondary';
        }

        function refreshMap() {
            console.log('üîÑ Refreshing map data...');
            loadStationStatus();
        }

        function focusOnLocation(lat, lng) {
            if (map) {
                map.setView([lat, lng], 10);
                console.log(`üìç Focused on location: ${lat}, ${lng}`);
            }
        }

        function showRecommendationsOnMap() {
            console.log('üó∫Ô∏è Showing recommendations on map...');
            
            // Clear existing recommendation markers
            recommendationMarkers.forEach(marker => map.removeLayer(marker));
            recommendationMarkers = [];
            
            // Add recommendation markers
            document.querySelectorAll('.recommendation-item').forEach((item, index) => {
                const lat = parseFloat(item.dataset.lat);
                const lng = parseFloat(item.dataset.lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'recommendation-marker',
                            html: `<div style="
                                background: #28a745; 
                                color: white; 
                                border-radius: 50%; 
                                width: 35px; 
                                height: 35px; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-weight: bold;
                                border: 3px solid white;
                                box-shadow: 0 3px 6px rgba(0,0,0,0.3);
                                font-size: 14px;
                            ">R${index + 1}</div>`,
                            iconSize: [35, 35]
                        })
                    }).addTo(map);
                    
                    // Get recommendation data
                    const recText = item.querySelector('h6 strong').textContent.replace('üìç ', '');
                    const priorityText = item.querySelector('.badge').textContent;
                    const demandText = item.querySelector('.small p:nth-child(2)').textContent;
                    const coverageText = item.querySelector('.small p:nth-child(3)').textContent;
                    const reasoningText = item.querySelector('.text-info').textContent.replace('üí° ', '');
                    
                    marker.bindPopup(`
                        <div class="text-center" style="min-width: 250px;">
                            <h6><strong>üéØ ${recText}</strong></h6>
                            <hr class="my-2">
                            <div class="text-start">
                                <p class="mb-1"><strong>Priority Score:</strong> ${priorityText}</p>
                                <p class="mb-1"><strong>${demandText.split(':')[0]}:</strong> ${demandText.split(':')[1]}</p>
                                <p class="mb-1"><strong>${coverageText.split(':')[0]}:</strong> ${coverageText.split(':')[1]}</p>
                                <p class="mb-0 small text-muted"><strong>Reasoning:</strong> ${reasoningText}</p>
                            </div>
                        </div>
                    `);
                    
                    recommendationMarkers.push(marker);
                }
            });
            
            // Fit map to show all recommendations within US bounds
            if (recommendationMarkers.length > 0) {
                const group = new L.featureGroup(recommendationMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
                
                // Ensure we don't zoom out too far (keep focus on continental US)
                if (map.getZoom() < 4) {
                    map.setZoom(4);
                }
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        function showError(message) {
            console.error('‚ùå Dashboard Error:', message);
            // You can add a toast notification here if needed
        }

        // Add some debugging
        window.addEventListener('error', function(e) {
            console.error('üö® JavaScript Error:', e.error);
        });

        console.log('üìã Dashboard script loaded successfully');
    </script>
</body>
</html>
